// -*- C++ -*-
#ifndef SAUCE_SAUCE_INJECTOR_H_
#define SAUCE_SAUCE_INJECTOR_H_

#include <sauce/builder>
#include <sauce/memory>
#include <sauce/internal/bindings>
#include <sauce/internal/deleter>

namespace sauce {

template<typename Module>
class Injector {

  typedef Module Module_;
  typedef Injector<Module_> Injector_;
  typedef ::sauce::internal::Deleter<Injector_> Deleter_;

  friend class ::sauce::internal::Deleter<Injector_>;

public:

  Injector() {}

  virtual ~Injector() {}

  template<typename Iface>
  SAUCE_SHARED_PTR<Iface> get() const {
    // Delegate after resolving the binding with EXTRA SUPER MAGIC
    return resolveAndProvide<Iface>(&Module_::template bindings<Injector_> );
  }

private:

  template<typename Iface>
  void dispose(Iface * iface) const {
    resolveAndDispose<Iface>(&Module_::template bindings<Injector_>, iface);
  }

  template<typename Iface, typename Binding>
  SAUCE_SHARED_PTR<Iface> resolveAndProvide(Binding * (*)(Iface)) const {
    // Ask the binding to provide an implementation
    Iface * provided = Binding::provide(*this);

    // Wrap in a smart pointer
    Deleter_ deleter(*this);
    SAUCE_SHARED_PTR<Iface> smartPointer;
    smartPointer.reset(provided, deleter);
    return smartPointer;
  }

  template<typename Iface, typename Binding>
  void resolveAndDispose(Binding * (*)(Iface), Iface * iface) const {
    Binding::dispose(*this, iface);
  }

};

}

#endif // ifndef SAUCE_SAUCE_INJECTOR_H_